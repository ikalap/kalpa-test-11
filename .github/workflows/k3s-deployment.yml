name: k3s-deployment
on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      # java编译
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Build with Maven
        run: mvn -B package --file pom.xml

      # docker build，并push
      - name: Docker push
        uses: azure/docker-login@v1
        with:
          login-server: ccr.ccs.tencentyun.com
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      - run: |
          docker build -t ccr.ccs.tencentyun.com/kalpa/kalpa-test:${{ github.sha }} -t ccr.ccs.tencentyun.com/kalpa/kalpa-test .
          docker push ccr.ccs.tencentyun.com/kalpa/kalpa-test:${{ github.sha }}
          docker push ccr.ccs.tencentyun.com/kalpa/kalpa-test

      # 让K8s应用deployment
      - run: |
          sed -i 's/{image_name}/ccr.ccs.tencentyun.com/kalpa/kalpa-test:${{ github.sha }}/g' deployment.yaml
      - name: deploy to cluster
        uses: steebchen/kubectl@master
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
          KUBECTL_VERSION: "1.32"
        with:
          args: apply -f deployment.yaml
      - name: verify deployment
        uses: steebchen/kubectl@master
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
          KUBECTL_VERSION: "1.32"
        with:
          args: '"rollout status -n default deployment/kalpa-tes"'
